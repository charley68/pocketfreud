<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Let's Talk - PocketFreud</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

    <!-- ‚úÖ Header -->
    <div class="top-bar authenticated">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="PocketFreud Logo" class="logo">
      <div class="branding">
        <h1 class="app-title">PocketFreud</h1>
      </div>
      <nav class="nav-buttons">
          <a class="logout-button" href="{{ url_for('logout') }}">Logout</a>
      </nav>
    </div>

  <div class="chat-header">
    <h1>Let's Talk</h1>
  </div>

  <div class="chat-wrapper">
    <div id="chatBox">
      {% if messages %}
        {% for msg in messages %}
          <div class="{{ 'user-message' if msg['sender'] == 'user' else 'bot-message' }}">
            <strong>{{ 'You' if msg['sender'] == 'user' else 'PocketFreud' }}:</strong> {{ msg['message'] }}
          </div>
        {% endfor %}
      {% else %}
        <div class="bot-message">
          <strong>PocketFreud:</strong> Hi {{ username }}. How are you feeling today?
        </div>
      {% endif %}
    </div>

    <div id="inputArea">
      <button id="newChatBtn" onclick="startNewChat()">‚úèÔ∏è</button>
      <input type="text" id="userInput" placeholder="What's on your mind, {{ username }}?">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <div class="bottom-nav">
    <a href="{{ url_for('home') }}"><div><i>üè†</i><div>Home</div></div></a>
    <a href="#"><div><i>üìì</i><div>Journal</div></div></a>
    <a href="#"><div><i>üìä</i><div>Insights</div></div></a>
    <div class="more-container">
      <div class="more-button" onclick="toggleMoreMenu()">
        <i>‚ãØ</i>
        <div>More</div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <h2 id="modalTitle">End This Session?</h2>
      <p id="modalMessage">You can give this chat a label to help find it later. Then we‚Äôll start a fresh one.</p>
      <input type="text" id="sessionLabel" placeholder="e.g. Anxious Morning" class="label-input">
      <div class="modal-buttons">
        <button id="confirmModalAction">Save & Continue</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="historyModal">
    <div class="modal modal-scroll">
      <h2>Your Chat History</h2>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Label</th>
            <th>Date</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="modal-buttons">
        <button onclick="closeHistoryModal()">Close</button>
      </div>
    </div>
  </div>

  <div class="more-menu" id="moreMenu" onclick="event.stopPropagation()">
    <a href="#" onclick="promptArchiveBeforeHistory()">üïì History</a>
    <a href="{{ url_for('logout') }}">üîì Logout</a>
  </div>

  <script>
    let groupTitle = {{ groupTitle|tojson }};
    let pendingRestore = null;

    function closeModal() {
      document.getElementById('confirmModal').style.display = 'none';
      pendingRestore = null;
    }

    function startNewChat() {
      document.getElementById('sessionLabel').value = '';
      document.getElementById('modalTitle').textContent = 'End This Session?';
      document.getElementById('modalMessage').textContent = "You can give this chat a label to help find it later. Then we‚Äôll start a fresh one.";
      document.getElementById('confirmModalAction').textContent = 'Save & Start New';
      document.getElementById('confirmModalAction').onclick = confirmNewChat;
      document.getElementById('confirmModal').style.display = 'flex';
    }

    async function confirmNewChat() {
      const label = document.getElementById('sessionLabel').value.trim();
      closeModal();
      await fetch('/api/new_chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groupTitle: label || 'Untitled Chat' })
      });
      chatBox.innerHTML = '';
      const welcome = document.createElement('div');
      welcome.className = 'bot-message';
      welcome.innerHTML = `<strong>PocketFreud:</strong> Hi again. How are you feeling today?`;
      chatBox.appendChild(welcome);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function restoreSession(groupTitle) {
      const countRes = await fetch('/api/unlabled_message_count');
      const { count } = await countRes.json();
      if (count <= 1) {
        await performRestore(groupTitle);
      } else {
        document.getElementById('sessionLabel').value = '';
        document.getElementById('modalTitle').textContent = 'Archive Current Session?';
        document.getElementById('modalMessage').textContent = 'Do you want to give the current conversation a label so it can be restored later or discard it ?';
        document.getElementById('confirmModalAction').textContent = 'Label & Switch';
        pendingRestore = groupTitle;
        document.getElementById('confirmModalAction').onclick = async () => {
          const label = document.getElementById('sessionLabel').value.trim();
          closeModal();
          await fetch('/api/new_chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ groupTitle: label || 'Untitled' })
          });
          await performRestore(pendingRestore);
        };
        document.getElementById('confirmModal').style.display = 'flex';
      }
    }

    async function performRestore(groupTitle) {
      await fetch('/api/restore_chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ restore: groupTitle })
      });
      location.reload();
    }

    const chatBox = document.getElementById('chatBox');

    async function sendMessage() {
      const userInputField = document.getElementById('userInput');
      const userInput = userInputField.value.trim();
      if (!userInput) return;

      const userMessage = document.createElement('div');
      userMessage.className = 'user-message';
      userMessage.innerHTML = `<strong>You:</strong> ${userInput}`;
      chatBox.appendChild(userMessage);
      chatBox.scrollTop = chatBox.scrollHeight;

      const typingMessage = document.createElement('div');
      typingMessage.className = 'bot-message';
      typingMessage.innerHTML = `<em>PocketFreud is typing...</em>`;
      chatBox.appendChild(typingMessage);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            messages: [{ role: 'user', content: userInput }],
            groupTitle: groupTitle  // üëà pass it here
          })
        });

        if (!response.ok) throw new Error(`Server error: ${response.status}`);
        const data = await response.json();
        chatBox.removeChild(typingMessage);

        const botMessage = document.createElement('div');
        botMessage.className = 'bot-message';
        botMessage.innerHTML = `<strong>PocketFreud:</strong> `;
        chatBox.appendChild(botMessage);

        const words = data.response.split(' ');
        let wordIndex = 0;
        const interval = setInterval(() => {
          if (wordIndex < words.length) {
            botMessage.innerHTML += words[wordIndex] + ' ';
            wordIndex++;
            chatBox.scrollTop = chatBox.scrollHeight;
          } else {
            clearInterval(interval);
          }
        }, 150);
      } catch (error) {
        const errorMessage = document.createElement('div');
        errorMessage.className = 'bot-message';
        errorMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
        chatBox.appendChild(errorMessage);
      }

      userInputField.value = '';
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    }

    let moreJustOpened = false;

    function toggleMoreMenu() {
      const menu = document.getElementById('moreMenu');
      const isVisible = menu.classList.contains('show');

      if (!isVisible) {
        menu.classList.add('show');
        moreJustOpened = true;
        setTimeout(() => { moreJustOpened = false; }, 200);
      } else {
        menu.classList.remove('show');
      }
    }

    window.addEventListener('click', function (e) {
      const menu = document.getElementById('moreMenu');
      const button = document.querySelector('.more-button');

      if (!button.contains(e.target) && !moreJustOpened) {
        menu.classList.remove('show');
      }
    });

    document.getElementById("userInput").addEventListener("keydown", function(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    function closeHistoryModal() {
      document.getElementById('historyModal').style.display = 'none';
    }

   
    
  async function promptArchiveBeforeHistory() {
    const countRes = await fetch('/api/unlabled_message_count');
    const { count } = await countRes.json();

    if (count <= 1) {
      // Nothing to save, just show history
      loadHistoryModal();
    } else {
      // Prompt to archive current session
      document.getElementById('sessionLabel').value = '';
      document.getElementById('modalTitle').textContent = 'Label & Save Current Session?';
      document.getElementById('modalMessage').textContent = 'You can give this session a label before switching.';
      document.getElementById('confirmModalAction').textContent = 'Save';

      document.getElementById('confirmModalAction').onclick = async () => {
        const label = document.getElementById('sessionLabel').value.trim();
        closeModal();

        await fetch('/api/new_chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupTitle: label || 'Untitled Chat' })
        });

        loadHistoryModal();
      };


      document.getElementById('confirmModal').style.display = 'flex';
    }
  }

  async function loadHistoryModal() {
    const modal = document.getElementById('historyModal');
    const tableBody = document.querySelector('#historyTable tbody');
    tableBody.innerHTML = '';

    try {
      const res = await fetch('/api/chat_history');
      const data = await res.json();

      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.groupTitle}</td>
          <td>${new Date(row.latest).toLocaleString()}</td>
          <td><button onclick="restoreSession('${row.groupTitle}')">Restore</button></td>
        `;
        tableBody.appendChild(tr);
      });

      modal.style.display = 'flex';
    } catch (err) {
      alert('Failed to load chat history.');
    }
  }

  </script>
</body>
</html>
